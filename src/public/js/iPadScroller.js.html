<!DOCTYPE html><html><head><title>iPadScroller.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../src/providers/RawArticleProvider.js.html" class="source "><span class="base_path">src / providers / </span><span class="file_name">RawArticleProvider.js</span></a><a href="../../../src/public/js/app.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">app.js</span></a><a href="../../../src/public/js/ArticleIndexView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">ArticleIndexView.js</span></a><a href="../../../src/public/js/ArticleViewModel.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">ArticleViewModel.js</span></a><a href="../../../src/public/js/client.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">client.js</span></a><a href="../../../src/public/js/iPadScroller.js.html" class="source selected"><span class="base_path">src / public / js / </span><span class="file_name">iPadScroller.js</span></a><a href="../../../src/public/js/MapView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">MapView.js</span></a><a href="../../../src/public/js/Models.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">Models.js</span></a><a href="../../../src/public/js/NarrationView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">NarrationView.js</span></a><a href="../../../src/public/js/TimelineView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">TimelineView.js</span></a><a href="../../../src/routes/routes.js.html" class="source "><span class="base_path">src / routes / </span><span class="file_name">routes.js</span></a><a href="../../../src/server.js.html" class="source "><span class="base_path">src / </span><span class="file_name">server.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>iPadScroller.js</h1><div class="filepath">src/public/js/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><p>iOS disables JavaScript execution during page scrolls, 
which prevents us from doing nice visual effects as the person scrolls the page around. 
To get around this, we disable native scrolling, and implement
our own scroller that listens for touch gestures on an element.
Naturally it is quite bare-bones compared to native scrolling.
Inspired by <a href="http://stackoverflow.com/questions/9592788/how-to-build-parallax-scroll-on-an-ios-device">How to build parallax scrolling on iOS</a></p>

<p>This uses the <strong>revealing module</strong> pattern to make iPadScroller an object with two public functions on it. See the end of the file.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">iPadScroller</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>This stops the iPad from doing any scrolling</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">disableDefaultScrolling</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">ontouchmove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">};</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>This implemented an approach to do scrolling while doing JavaScript computation on the iPad
by doing a CSS transform as a touch moves, rather than invoking
the browser's default scroll behavior.
This uses the <strong>delegate</strong> pattern to </p>

<p>@listenEl  - Element - the element on which touches are captured
 @scrollEl  - Element - the element that is scroller
 @delegate - fn(int,isDone) - a hook to interrupt scrolling and capture scroll progress</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">createScroller</span><span class="p">(</span><span class="nx">listenEl</span><span class="p">,</span> <span class="nx">scrollEl</span><span class="p">,</span> <span class="nx">delegate</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Variables to help during scroll operations</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">startY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
    <span class="kd">var</span> <span class="nx">currentY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Get the total height of the element that we want to scroll.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">maxY</span> <span class="o">=</span> <span class="nx">scrollEl</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Here we handle when a touch starts, but recording its position.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">handleStart</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">changedTouches</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">startY</span> <span class="o">=</span> <span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pageY</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Event handling function for moves</p>
</td><td class="code"><div class="highlight"><pre>     <span class="kd">var</span> <span class="nx">handleMove</span>   <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">moveOrEnd</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
     <span class="p">};</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Event handling function for anything that finished the touch</p>
</td><td class="code"><div class="highlight"><pre>     <span class="kd">var</span> <span class="nx">handleDone</span>    <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">moveOrEnd</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
     <span class="p">};</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Here we handle touches moving or ending,
by calculating their offset from the start and calling out to the scroll function.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">moveOrEnd</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">isDone</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">changedTouches</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newY</span> <span class="o">=</span> <span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pageY</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">offsetY</span> <span class="o">=</span> <span class="nx">newY</span> <span class="o">-</span> <span class="nx">startY</span><span class="p">;</span>
        <span class="nx">scrollFn</span><span class="p">(</span><span class="nx">offsetY</span><span class="p">,</span> <span class="nx">isDone</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>The scroll function calculates a new position for the element,
potentially clamping it if it is beyond the element's boundaries,
and calls <code>doScroll</code> to actually apply the scroll.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">scrollFn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offsetY</span><span class="p">,</span> <span class="nx">isDone</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">newY</span> <span class="o">=</span> <span class="nx">currentY</span> <span class="o">+</span> <span class="nx">offsetY</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">newY</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">newY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>It's unclear when we want to actually stop the scroll, so we leave this blank.
if (newY &lt; -maxY + screen.width)
  newY = -maxY + screen.width;</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">doScroll</span><span class="p">(</span><span class="nx">newY</span><span class="p">,</span> <span class="nx">isDone</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>This injects the delegate function into the new position calculation,
giving an external function an opportunity to influence the scroll's behaviour,
and applies a CSS3 transform to actually move the element on screen.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">doScroll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newY</span><span class="p">,</span> <span class="nx">isDone</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">delegate</span><span class="p">)</span>
        <span class="nx">newY</span> <span class="o">=</span> <span class="o">-</span><span class="nx">delegate</span><span class="p">(</span><span class="o">-</span><span class="nx">newY</span><span class="p">,</span> <span class="nx">isDone</span><span class="p">);</span>  

      <span class="k">if</span> <span class="p">(</span><span class="nx">isDone</span><span class="p">)</span>
        <span class="nx">currentY</span> <span class="o">=</span> <span class="nx">newY</span><span class="p">;</span>

      <span class="nx">scrollEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">webkitTransform</span> <span class="o">=</span> <span class="s1">&#39;translate(0, &#39;</span> <span class="o">+</span> <span class="nx">newY</span> <span class="o">+</span> <span class="s1">&#39;px)&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Register all the touch-based event listeners.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">listenEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchstart&quot;</span><span class="p">,</span>  <span class="nx">handleStart</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">listenEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchmove&quot;</span><span class="p">,</span>   <span class="nx">handleMove</span><span class="p">,</span>  <span class="kc">false</span><span class="p">);</span>
    <span class="nx">listenEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchend&quot;</span><span class="p">,</span>    <span class="nx">handleDone</span><span class="p">,</span>  <span class="kc">false</span><span class="p">);</span>
    <span class="nx">listenEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchleave&quot;</span><span class="p">,</span>  <span class="nx">handleDone</span><span class="p">,</span>  <span class="kc">false</span><span class="p">);</span>
    <span class="nx">listenEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchcancel&quot;</span><span class="p">,</span> <span class="nx">handleDone</span><span class="p">,</span>  <span class="kc">false</span><span class="p">);</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Give the delegate function a chance to initialze itself with a start position of 0</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">delegate</span><span class="p">)</span>
      <span class="nx">delegate</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Return an object that allow the creator to force scrolls, and destroy all the event handlers.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">scrollTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pix</span><span class="p">,</span> <span class="nx">skipDelegate</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">doScroll</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="nx">pix</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span> <span class="nx">skipDelegate</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">scrollEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">webkitTransform</span> <span class="o">=</span> <span class="s1">&#39;translate(0px, 0px)&#39;</span><span class="p">;</span>
        <span class="nx">listenEl</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;touchstart&quot;</span><span class="p">,</span>  <span class="nx">handleStart</span><span class="p">);</span>
        <span class="nx">listenEl</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;touchmove&quot;</span><span class="p">,</span>   <span class="nx">handleMove</span><span class="p">);</span>
        <span class="nx">listenEl</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;touchend&quot;</span><span class="p">,</span>    <span class="nx">handleDone</span><span class="p">);</span>
        <span class="nx">listenEl</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;touchleave&quot;</span><span class="p">,</span>  <span class="nx">handleDone</span><span class="p">);</span>
        <span class="nx">listenEl</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s2">&quot;touchcancel&quot;</span><span class="p">,</span> <span class="nx">handleDone</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Expose the two public methods of this module</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">createScroller</span><span class="o">:</span> <span class="nx">createScroller</span><span class="p">,</span>
    <span class="nx">disableDefaultScrolling</span><span class="o">:</span> <span class="nx">disableDefaultScrolling</span>
  <span class="p">}</span>

<span class="p">})();</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><h2>Back to <a href="NarrationView.js.html">NarrationView.js</a></h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr></tbody></table><div id="generated">generated Mon Jul 15 2013 00:01:25 GMT-0700 (PDT)  </div></div></body></html>