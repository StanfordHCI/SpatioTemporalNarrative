<!DOCTYPE html><html><head><title>MapView.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../src/providers/RawArticleProvider.js.html" class="source "><span class="base_path">src / providers / </span><span class="file_name">RawArticleProvider.js</span></a><a href="../../../src/public/js/app.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">app.js</span></a><a href="../../../src/public/js/ArticleIndexView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">ArticleIndexView.js</span></a><a href="../../../src/public/js/ArticleViewModel.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">ArticleViewModel.js</span></a><a href="../../../src/public/js/client.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">client.js</span></a><a href="../../../src/public/js/iPadScroller.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">iPadScroller.js</span></a><a href="../../../src/public/js/MapView.js.html" class="source selected"><span class="base_path">src / public / js / </span><span class="file_name">MapView.js</span></a><a href="../../../src/public/js/Models.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">Models.js</span></a><a href="../../../src/public/js/NarrationView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">NarrationView.js</span></a><a href="../../../src/public/js/TimelineView.js.html" class="source "><span class="base_path">src / public / js / </span><span class="file_name">TimelineView.js</span></a><a href="../../../src/routes/routes.js.html" class="source "><span class="base_path">src / routes / </span><span class="file_name">routes.js</span></a><a href="../../../src/server.js.html" class="source "><span class="base_path">src / </span><span class="file_name">server.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>MapView.js</h1><div class="filepath">src/public/js/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><p>This module uses the Google Maps API to draw the map, add markers based on event data, and respond to user interaction events
(which may originate from other modules, such as the NarrationView or TimelineView). </p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p><a href="https://developers.google.com/maps/documentation/javascript/reference">Google Maps API Reference</a> </p>
</td><td class="code"><div class="highlight"><pre><span class="nx">MapView</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">MapView</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">model</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">modelView</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">modelView</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_delegateEvents</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">,</span> <span class="p">{</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Sets the container element for the map</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">setElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">el</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;View requires a container element&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span> <span class="k">instanceof</span> <span class="nx">$</span> <span class="o">?</span> <span class="nx">el</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">el</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$el</span> <span class="o">=</span> <span class="nx">el</span> <span class="k">instanceof</span> <span class="nx">$</span> <span class="o">?</span> <span class="nx">el</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
    <span class="p">},</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Initializes event listeners for setting up the map and responding to scroll events</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">modelView</span><span class="p">,</span> <span class="s2">&quot;setup&quot;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">renderFromScratch</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">modelView</span><span class="p">,</span> <span class="s2">&quot;scroll:at&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">renderScrolled</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">});</span>

    <span class="p">},</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Responds to the "setup" event; initializes the map. </p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">renderFromScratch</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>The current element highlighted on the map (point, line, or area). </p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> 
      </pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Map from event ids to points on the map (represented by <a href="https://developers.google.com/maps/documentation/javascript/reference#Marker">Google Maps Markers</a> objects).</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span> <span class="o">=</span> <span class="p">{};</span> </pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Map from event ids to areas on the map (represented by <a href="https://developers.google.com/maps/documentation/javascript/reference#Polygon">Google Maps Polygons</a> objects).</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Map from event ids to multi-point lists/lines (represented by <a href="https://developers.google.com/maps/documentation/javascript/reference#Polyline">Google Maps Polylines</a> objects). </p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span> <span class="o">=</span> <span class="p">{};</span> </pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Map from spatial names to Google objects. 
Used primarily to ensure that map objects are not rendered more than once (for example, if more than one event is associated with a point/line/area). </p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">poiMapObjects</span> <span class="o">=</span> <span class="p">{};</span>
      </pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Map from event ids to Lat-Longs. </p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">eventLocations</span> <span class="o">=</span> <span class="p">{};</span> </pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Stores which event ID we are currently on. </p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">config</span><span class="p">.</span><span class="nx">atCurrentId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Stores the bounding box for the initial map bounds.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">bounds</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLngBounds</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">boundsCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><hr />

<p>Immediately-invoked function which creates the map. </p>

<hr />
</td><td class="code"><div class="highlight"><pre>      <span class="p">(</span><span class="kd">function</span> <span class="nx">createMap</span><span class="p">()</span> <span class="p">{</span>
        
        <span class="kd">var</span> <span class="nx">center</span><span class="p">;</span> </pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Retrieve list of locations from the "map" field of the model. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">locations</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">).</span><span class="nx">poi</span><span class="p">;</span>
        </pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Find the first point with an existing lat-long value (i.e., does not need to be geocoded) and use that point as the center of the map. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">locations</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">locations</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">center</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">lng</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">zoom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;startingZoomLevel&quot;</span><span class="p">);</span> 
        </pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Set the map options and create the <a href="https://developers.google.com/maps/documentation/javascript/reference#Map">Google Map</a> object. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">mapOptions</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">center</span><span class="o">:</span> <span class="nx">center</span><span class="p">,</span> 
          <span class="nx">zoom</span><span class="o">:</span> <span class="nx">zoom</span><span class="p">,</span>
          <span class="nx">mapTypeId</span><span class="o">:</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">MapTypeId</span><span class="p">.</span><span class="nx">ROADMAP</span>
        <span class="p">};</span>

        <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">mapOptions</span><span class="p">);</span>

      <span class="p">}).</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p><strong><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</strong> END MAP CREATION <strong></em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em>**</strong></p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><hr />

<p>Immediately-invoked function for adding event markers to the map. </p>

<hr />
</td><td class="code"><div class="highlight"><pre>      <span class="p">(</span><span class="kd">function</span> <span class="nx">addMarkers</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Creates and adds <a href="https://developers.google.com/maps/documentation/javascript/reference#Marker">Google Maps Markers</a> to the map for point-based events. 
Arguments: latlng is the location at which to add the marker, id is the text to place on the marker (matches the id of the corresponding event).</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">drawMarker</span><span class="p">(</span><span class="nx">latlng</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Extend the bounds of the map to ensure that this point is visible.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">bounds</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">latlng</span><span class="p">);</span> 
          <span class="nx">boundsCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

          <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

          <span class="nx">marker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Marker</span><span class="p">({</span>
            <span class="nx">position</span><span class="o">:</span> <span class="nx">latlng</span><span class="p">,</span>
            <span class="nx">map</span><span class="o">:</span> <span class="nx">map</span><span class="p">,</span>
            <span class="nx">animation</span><span class="o">:</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Animation</span><span class="p">.</span><span class="nx">NONE</span><span class="p">,</span>
            <span class="nx">icon</span><span class="o">:</span> <span class="nx">generateMarkerSVG</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s2">&quot;rgb(68,121,186)&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
          <span class="p">});</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Store a reference to this marker object in the eventMarkers array, so the marker can be accessed and updated in response to touches/scrolls.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">marker</span><span class="p">;</span> </pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Add an event listener for when this map marker is touched/clicked. </p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>If there exists a currently-highlighted marker, reset that marker to its default state (i.e., colored blue). </p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">num</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span><span class="p">;</span> 
              <span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">num</span><span class="p">].</span><span class="nx">setIcon</span><span class="p">(</span><span class="nx">generateMarkerSVG</span><span class="p">(</span><span class="nx">num</span><span class="p">.</span><span class="nx">toString</span><span class="p">()));</span> 
            <span class="p">}</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Set the touched marker's color to red, store it as the current marker, and pan the map to the marker. </p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">marker</span><span class="p">.</span><span class="nx">setIcon</span><span class="p">(</span><span class="nx">generateMarkerSVG</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s2">&quot;red&quot;</span><span class="p">));</span> 
            <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span> 
            <span class="nx">map</span><span class="p">.</span><span class="nx">panTo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">getPosition</span><span class="p">());</span> </pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Emit a scroll event to inform the Timeline and Narration Views that the currently-selected event has changed. </p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">modelView</span><span class="p">.</span><span class="nx">scrollHasReached</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span> 
          <span class="p">});</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Creates and adds <a href="https://developers.google.com/maps/documentation/javascript/reference#Polyline">Google Maps Polylines</a> to the map for list-based events (ex: a path or route traveled). 
Arguments: coords is an array of <a href="https://developers.google.com/maps/documentation/javascript/reference#LatLng">LatLng</a> objects, id is the id of the event corresponding to the line(s), scale represents an optional scaling parameter (for thicker or thinner lines). </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">drawLine</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">scale</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">weight</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> 
          <span class="k">if</span> <span class="p">(</span><span class="nx">scale</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">scale</span><span class="p">)))</span> <span class="p">{</span>
            <span class="nx">weight</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">-</span> <span class="mf">0.00051136</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100000</span> <span class="o">-</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">scale</span><span class="p">));</span> 
          <span class="p">}</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>Create the symbol that is repeated to form the dotted-line. </p>
</td><td class="code"><div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">lineSymbol</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;M 0,-1 0,1&#39;</span><span class="p">,</span>
            <span class="nx">strokeColor</span><span class="o">:</span> <span class="s1">&#39;#4479BA&#39;</span><span class="p">,</span>
            <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">scale</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nx">strokeWeight</span><span class="o">:</span> <span class="nx">weight</span>
          <span class="p">};</span>

          <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Polyline</span><span class="p">({</span>
            <span class="nx">path</span><span class="o">:</span> <span class="nx">coords</span><span class="p">,</span>
            <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">icons</span><span class="o">:</span> <span class="p">[{</span>
              <span class="nx">icon</span><span class="o">:</span> <span class="nx">lineSymbol</span><span class="p">,</span>
              <span class="nx">offset</span><span class="o">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
              <span class="nx">repeat</span><span class="o">:</span> <span class="s1">&#39;15px&#39;</span>
            <span class="p">}],</span>
            <span class="nx">map</span><span class="o">:</span> <span class="nx">map</span>
          <span class="p">});</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Store a reference to the line object. </p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span> 
        <span class="p">}</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Creates and adds <a href="https://developers.google.com/maps/documentation/javascript/reference#Polygon">Google Maps Polygons</a> to the map for area-based events. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">drawArea</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">area</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">({</span>
            <span class="nx">paths</span><span class="o">:</span> <span class="nx">coords</span><span class="p">,</span>
            <span class="nx">strokeColor</span><span class="o">:</span> <span class="s1">&#39;#4479BA&#39;</span><span class="p">,</span>
            <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="nx">strokeWeight</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">fillColor</span><span class="o">:</span> <span class="s1">&#39;#3368A9&#39;</span><span class="p">,</span>
            <span class="nx">fillOpacity</span><span class="o">:</span> <span class="mf">0.25</span>
          <span class="p">});</span>
          <span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">area</span><span class="p">;</span> 
          <span class="nx">area</span><span class="p">.</span><span class="nx">setMap</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>Converts address-based location info into <a href="https://developers.google.com/maps/documentation/javascript/reference#LatLng">LatLngs</a>
using the <a href="https://developers.google.com/maps/documentation/javascript/reference#Geocoder">Google Maps Geocoder</a>. 
Because the geocoder request is asynchronous, the user must pass in a callback function to be executed once the request has returned. 
This callback function must accept an error string as its first argument, and the result array as its second argument. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">geocoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Geocoder</span><span class="p">();</span>
        <span class="kd">function</span> <span class="nx">addressToLatLng</span><span class="p">(</span><span class="nx">poi</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">address</span><span class="o">:</span> <span class="nx">poi</span><span class="p">.</span><span class="nx">value</span>
          <span class="p">}</span>
          <span class="nx">geocoder</span><span class="p">.</span><span class="nx">geocode</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>If the geocoder request completes successfully, execute callback with the results. </p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">GeocoderStatus</span><span class="p">.</span><span class="nx">OK</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Otherwise, execute the callback with an error message. </p>
</td><td class="code"><div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>Creates a <a href="https://developers.google.com/maps/documentation/javascript/reference#LatLng">LatLng</a> object for a point-based event, 
then passes that LatLng to the drawMarker() function to instantiate it on the map. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">createEventPoint</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">latlng</span><span class="p">;</span>
          </pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>If the point is an address, it has to be geocoded with the addressToLatLng() function before the marker can be created. </p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">addressToLatLng</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">config</span><span class="p">.</span><span class="nx">eventLocations</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>  
                  <span class="nx">drawMarker</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span> 
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Could not get lat-long from google - possibly over API limit?&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                  <span class="nx">boundsCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">});</span>
            <span class="p">})(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>If the point is already in lat-long form, just pull out the respective data fields and create a corresponding <a href="https://developers.google.com/maps/documentation/javascript/reference#LatLng">Google Maps LatLng</a> object. </p>
</td><td class="code"><div class="highlight"><pre>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">)</span> <span class="p">{</span>
          
            <span class="nx">latlng</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">lng</span><span class="p">);</span> 
            <span class="nx">config</span><span class="p">.</span><span class="nx">eventLocations</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">latlng</span><span class="p">;</span> 
            <span class="nx">drawMarker</span><span class="p">(</span><span class="nx">latlng</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span> 
          
          <span class="p">}</span>

        <span class="p">}</span> </pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Creates an array of <a href="https://developers.google.com/maps/documentation/javascript/reference#LatLng">LatLng</a> coordinates which define the vertices of a polygon. This coordinate array is then passed to the drawArea() function to be instantiated on the map.
Currently only supports event areas that are already defined by lat-long-based subpoints, because geocoding all the addresses required to define a complex polygon is not only slow, but also likely to exceed the Google Maps API geocoding limit.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">createEventArea</span><span class="p">(</span><span class="nx">area_poi</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>If an area object already exists with the same name as this one, 
then associate the given event id with that same area object (rather than double-creating a new, identical one)/ </p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">poiMapObjects</span><span class="p">[</span><span class="nx">area_poi</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">poiMapObjects</span><span class="p">[</span><span class="nx">area_poi</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>

          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">coords</span> <span class="o">=</span> <span class="p">[];</span> 
            <span class="kd">var</span> <span class="nx">subpoints</span> <span class="o">=</span> <span class="nx">area_poi</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> 
            <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">subpoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> 

            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">subpoints</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">subpoint</span> <span class="o">=</span> <span class="nx">subpoints</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> 
              <span class="k">if</span> <span class="p">(</span><span class="nx">subpoint</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Does not support address subpoints&quot;</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">subpoint</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">latlng</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">subpoint</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">subpoint</span><span class="p">.</span><span class="nx">lng</span><span class="p">);</span> 
                <span class="nx">coords</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">latlng</span><span class="p">;</span> 
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">poiMapObjects</span><span class="p">[</span><span class="nx">area_poi</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">drawArea</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>             
          <span class="p">}</span>

        <span class="p">}</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Creates an array of <a href="https://developers.google.com/maps/documentation/javascript/reference#LatLng">LatLng</a> coordinates, which defines an ordered list of points to draw lines between. This coordinate array is then passed to the drawLine() function to be instantiated on the map.
Makes the simplifying assumption that all coordinates are addresses, or all coordinates are points (no mixing). </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">createEventList</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">scale</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">subpoints</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> 
          <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">subpoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> 

          <span class="k">if</span> <span class="p">(</span><span class="nx">subpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Assume everything is an address. </p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>Use the async.js library to ensure that all addresses have been geocoded to LatLngs before passing the coordinates array to the drawLine() function. </p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">async</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">subpoints</span><span class="p">,</span> <span class="nx">addressToLatLng</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>

              <span class="kd">var</span> <span class="nx">coords</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
              <span class="nx">results</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">geocodedLocation</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">latlng</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">geocodedLocation</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">lat</span><span class="p">(),</span> <span class="nx">geocodedLocation</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">lng</span><span class="p">());</span> 
                <span class="nx">coords</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">latlng</span><span class="p">;</span> 
              <span class="p">});</span>
              <span class="nx">drawLine</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">scale</span><span class="p">);</span>

            <span class="p">});</span>

          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>Assume everything is a point</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">coords</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">subpoints</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">subpoints</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">latlng</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">lng</span><span class="p">);</span> 
              <span class="nx">coords</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">latlng</span><span class="p">;</span> 
            <span class="p">});</span>
            <span class="nx">drawLine</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">scale</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">}</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>Get all events and map locations from the model. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">events</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">);</span> 
        <span class="kd">var</span> <span class="nx">locations</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">).</span><span class="nx">poi</span><span class="p">;</span> </pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>For each event, cycle through the map locations to find a location with a name that matches the spatial field of the event.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">numberOfPoints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">forAllEvents</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">spatial</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">spatial</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">spatial</span><span class="p">;</span> 
            <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="k">in</span> <span class="nx">locations</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">spatial</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>If the location is a point or an address, create a point for it on the map. </p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span> <span class="o">||</span> <span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">numberOfPoints</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="nx">createEventPoint</span><span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">event</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> </pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><p>If the location is an area, create a polygon area for it on the map. </p>
</td><td class="code"><div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;area&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">createEventArea</span><span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">event</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> </pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>If the location is a list of points, create a list of coordinates and draw connecting lines between them on the map. </p>
</td><td class="code"><div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">createEventList</span><span class="p">(</span><span class="nx">locations</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">event</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">participants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>

        <span class="p">});</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><p>Spinlock: wait to fit the bounds of the map until all the markers have been added to the bounds object.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">spinUntilAllMarkers</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">boundsCount</span> <span class="o">==</span> <span class="nx">numberOfPoints</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">map</span><span class="p">.</span><span class="nx">fitBounds</span><span class="p">(</span><span class="nx">bounds</span><span class="p">);</span> 
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">spinUntilAllMarkers</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">spinUntilAllMarkers</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

      <span class="p">})();</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><p><strong><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em></strong> END MARKER ADDING <strong></em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em>*</strong></p>
</td><td class="code"><div class="highlight"><pre>      

      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><p>Renders the map in response to received scroll events. 
Takes in the ID of the event which has just been scrolled to. </p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">renderScrolled</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">intID</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">;</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><p>Coerce ID to string</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">intID</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> </pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><p>If the ID of the currently-selected event matches the ID of the scrolled-to event, we're already where we need to be, and can return without taking action. </p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">atCurrentId</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">config</span><span class="p">.</span><span class="nx">atCurrentId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><p>Reset the old highlighted marker back to its original state (i.e., the default light blue color)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">curr</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span><span class="p">;</span> </pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><p>If the old marker was a point marker.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">icon</span> <span class="o">=</span> <span class="nx">generateMarkerSVG</span><span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
          <span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">curr</span><span class="p">].</span><span class="nx">setIcon</span><span class="p">(</span><span class="nx">icon</span><span class="p">);</span> </pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><p>If the old marker was an area / polygon. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">strokeColor</span><span class="o">:</span> <span class="s2">&quot;#4479BA&quot;</span><span class="p">,</span>
            <span class="nx">fillColor</span><span class="o">:</span> <span class="s2">&quot;#4479BA&quot;</span>
          <span class="p">};</span> 
          <span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">curr</span><span class="p">].</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> </pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><p>If the old marker was a list / line. </p>
</td><td class="code"><div class="highlight"><pre>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getEventById</span><span class="p">(</span><span class="nx">curr</span><span class="p">).</span><span class="nx">participants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
          <span class="kd">var</span> <span class="nx">weight</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> 
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">scale</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">weight</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">-</span> <span class="mf">0.00051136</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100000</span> <span class="o">-</span> <span class="nx">scale</span><span class="p">);</span> 
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">lineSymbol</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;M 0,-1 0,1&#39;</span><span class="p">,</span>
            <span class="nx">strokeColor</span><span class="o">:</span> <span class="s1">&#39;#4479BA&#39;</span><span class="p">,</span>
            <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">scale</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> 
            <span class="nx">strokeWeight</span><span class="o">:</span> <span class="nx">weight</span>
          <span class="p">};</span>

          <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">icons</span><span class="o">:</span> <span class="p">[{</span>
              <span class="nx">icon</span><span class="o">:</span> <span class="nx">lineSymbol</span><span class="p">,</span>
              <span class="nx">offset</span><span class="o">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
              <span class="nx">repeat</span><span class="o">:</span> <span class="s1">&#39;15px&#39;</span>
            <span class="p">}],</span>
          <span class="p">}</span>

          <span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span><span class="p">[</span><span class="nx">curr</span><span class="p">].</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> 
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><p>Sets the color of the newly-selected marker (the one that has just been scrolled to) to be highlighted in red,
and stores it as the currently-selected marker. </p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><p>If the newly-selected marker is a point.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">icon</span> <span class="o">=</span> <span class="nx">generateMarkerSVG</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="s2">&quot;red&quot;</span><span class="p">);</span> 
        <span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">setIcon</span><span class="p">(</span><span class="nx">icon</span><span class="p">);</span> 
        <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span> 
        <span class="nx">map</span><span class="p">.</span><span class="nx">panTo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventMarkers</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">getPosition</span><span class="p">());</span> </pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>If the newly-selected marker is an area / polygon.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">strokeColor</span><span class="o">:</span> <span class="s2">&quot;#FF0000&quot;</span><span class="p">,</span>
          <span class="nx">fillColor</span><span class="o">:</span> <span class="s2">&quot;#FF0000&quot;</span>
        <span class="p">};</span> 
        <span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> 
        <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span> 
        <span class="nx">map</span><span class="p">.</span><span class="nx">panTo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventAreas</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">getPath</span><span class="p">().</span><span class="nx">getAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span> </pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><p>If the newly-selected marker is a list / line.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getEventById</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">participants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
        <span class="kd">var</span> <span class="nx">weight</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">scale</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">weight</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">-</span> <span class="mf">0.00051136</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100000</span> <span class="o">-</span> <span class="nx">scale</span><span class="p">);</span> 
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">lineSymbol</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;M 0,-1 0,1&#39;</span><span class="p">,</span>
          <span class="nx">strokeColor</span><span class="o">:</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">,</span>
          <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">scale</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> 
          <span class="nx">strokeWeight</span><span class="o">:</span> <span class="nx">weight</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">icons</span><span class="o">:</span> <span class="p">[{</span>
            <span class="nx">icon</span><span class="o">:</span> <span class="nx">lineSymbol</span><span class="p">,</span>
            <span class="nx">offset</span><span class="o">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
            <span class="nx">repeat</span><span class="o">:</span> <span class="s1">&#39;15px&#39;</span>
          <span class="p">}],</span>
        <span class="p">}</span>

        <span class="nx">config</span><span class="p">.</span><span class="nx">currentMarker</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span> 
        <span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">setOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> 
        <span class="nx">map</span><span class="p">.</span><span class="nx">panTo</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">eventLists</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">getPath</span><span class="p">().</span><span class="nx">getAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span> 

      <span class="p">}</span>
    <span class="p">},</span>
    
    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">_delegateEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><p>Where we hook up UI event handlers</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="p">},</span>

  <span class="p">});</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><hr />

<p>Here we generate SVG markers for the map on the client side.
We hash them to a data-uri, which is cached using memoization hashes. </p>

<hr />
</td><td class="code"><div class="highlight"><pre>  

  <span class="kd">var</span> <span class="nx">svgText</span> <span class="o">=</span> <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;&#39;</span>
  <span class="nx">svgText</span> <span class="o">+=</span> <span class="s1">&#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;30&quot; height=&quot;38&quot;&gt;&#39;</span>
  <span class="nx">svgText</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;polygon points=&quot;0,0 0,32 12,32 15,38 18,32 30,32 30,0&quot; style=&quot;fill:&lt;%COLOR%&gt;;stroke-width:0.5;stroke:black;stroke-location:inside;&quot;/&gt;&#39;</span>
  <span class="nx">svgText</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;text style=&quot;font-family:museo,Helvetica; font-weight:100; text-anchor:middle; font-size: 10pt; baseline-shift:-33%;&quot; x=&quot;15&quot; y=&quot;16&quot; fill=&quot;white&quot;&gt;&lt;%TEXT%&gt;&lt;/text&gt;&#39;</span>
  <span class="nx">svgText</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/svg&gt;&#39;</span>

  <span class="kd">var</span> <span class="nx">memoizeSVG</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">memoizeSVG</span> <span class="o">=</span> <span class="nx">memoizeSVG</span><span class="p">;</span></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><p>Generates an SVG marker based on the given text, color, and alternate color (which determines the color the marker switches to when it has been selected/scrolled to). </p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">generateMarkerSVG</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">alt_color</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">color</span> <span class="o">||</span> <span class="s2">&quot;rgb(68,121,186)&quot;</span><span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">alt_color</span> <span class="o">=</span> <span class="nx">alt_color</span> <span class="o">||</span> <span class="s2">&quot;red&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">||</span> <span class="s2">&quot;-&quot;</span><span class="p">;</span> 

    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot;--HASH--&quot;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">alt_hash</span> <span class="o">=</span> <span class="nx">alt_color</span> <span class="o">+</span> <span class="s2">&quot;--HASH--&quot;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">memoizeSVG</span><span class="p">[</span><span class="nx">hash</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">memoizeSVG</span><span class="p">[</span><span class="nx">hash</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">newText</span> <span class="o">=</span> <span class="nx">svgText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;&lt;%TEXT%&gt;&quot;</span><span class="p">,</span> <span class="nx">text</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;&lt;%COLOR%&gt;&quot;</span><span class="p">,</span> <span class="nx">color</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">altText</span> <span class="o">=</span> <span class="nx">svgText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;&lt;%TEXT%&gt;&quot;</span><span class="p">,</span> <span class="nx">text</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;&lt;%COLOR%&gt;&quot;</span><span class="p">,</span> <span class="nx">alt_color</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">b64</span> <span class="o">=</span> <span class="s2">&quot;data:image/svg+xml;base64,&quot;</span> <span class="o">+</span> <span class="nx">Base64</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">newText</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">alt_b64</span> <span class="o">=</span> <span class="s2">&quot;data:image/svg+xml;base64,&quot;</span> <span class="o">+</span> <span class="nx">Base64</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">altText</span><span class="p">);</span>

    <span class="nx">memoizeSVG</span><span class="p">[</span><span class="nx">hash</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b64</span><span class="p">;</span>
    <span class="nx">memoizeSVG</span><span class="p">[</span><span class="nx">alt_hash</span><span class="p">]</span> <span class="o">=</span> <span class="nx">alt_b64</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">b64</span><span class="p">;</span>

  <span class="p">}</span>


  <span class="k">return</span> <span class="nx">MapView</span><span class="p">;</span>

<span class="p">})();</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><h2>Next see <a href="MapView.js.html">MapView.js</a>, <a href="TimelineView.js.html">TimelineView.js</a> or <a href="NarrationView.js.html">NarrationView.js</a>. Or you're done!</h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr></tbody></table><div id="generated">generated Mon Jul 15 2013 00:01:26 GMT-0700 (PDT)  </div></div></body></html>